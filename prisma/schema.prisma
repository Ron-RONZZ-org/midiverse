// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User roles enum
enum UserRole {
  user
  content_manager
  administrator
}

// User status enum
enum UserStatus {
  active
  suspended
}

model User {
  id                  String      @id @default(uuid())
  email               String      @unique
  username            String      @unique
  password            String
  emailVerified       Boolean     @default(false)
  emailVerificationToken String?
  emailVerificationTokenExpiry DateTime?
  passwordResetToken  String?     // Token for password reset
  passwordResetTokenExpiry DateTime?
  pendingEmail        String?     // New email address pending verification
  pendingEmailToken   String?     // Token to verify pending email change
  pendingEmailTokenExpiry DateTime? // Expiry for pending email verification token
  displayName         String?     // Display name for profile
  description         String?     // Profile description
  profilePictureUrl   String?     // Profile picture URL
  profileBackgroundColor String?  // Optional color background for profile picture (hexcode)
  role                UserRole    @default(user)     // User role: user, content_manager, administrator
  status              UserStatus  @default(active)   // User status: active, suspended
  suspendedUntil      DateTime?   // When suspension expires (null = permanent or not suspended)
  lastEmailChange     DateTime?
  lastUsernameChange  DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  markmaps            Markmap[]
  series              Series[]
  viewHistory         ViewHistory[]
  interactions        Interaction[]
  preferences         UserPreferences?
  createdKeynodes     Keynode[]        @relation("KeynodeCreator")
  complaints          Complaint[]      @relation("ComplaintReporter")
  resolvedComplaints  Complaint[]      @relation("ComplaintResolver")
  notifications       Notification[]

  @@index([role])
  @@index([status])
}

// Markmap review status enum (for retired markmaps after editing)
enum MarkmapReviewStatus {
  none           // Normal published state
  action_required // Retired due to sustained complaint, needs author edit
  pending_review  // Edited by author, waiting for content manager review
}

model Markmap {
  id                  String    @id @default(uuid())
  title               String
  slug                String    // URL-friendly version of title with counter for duplicates
  text                String
  language            String?
  maxWidth            Int       @default(0)
  colorFreezeLevel    Int       @default(0)
  initialExpandLevel  Int       @default(-1)
  isPublic            Boolean   @default(true)
  isRetired           Boolean   @default(false)  // Retired from public view due to sustained complaint
  reviewStatus        MarkmapReviewStatus @default(none)  // Review workflow status
  deletedAt           DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  authorId      String?
  author        User?         @relation(fields: [authorId], references: [id])
  seriesId      String?
  series        Series?       @relation(fields: [seriesId], references: [id])
  viewHistory   ViewHistory[]
  interactions  Interaction[]
  tags          TagOnMarkmap[]
  keynodes      KeynodeOnMarkmap[]
  complaints    Complaint[]

  @@unique([authorId, slug])
  @@index([authorId])
  @@index([seriesId])
  @@index([isPublic])
  @@index([isRetired])
  @@index([reviewStatus])
  @@index([language])
  @@index([deletedAt])
  @@index([slug])
}

model ViewHistory {
  id         String   @id @default(uuid())
  viewedAt   DateTime @default(now())

  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  markmapId  String
  markmap    Markmap  @relation(fields: [markmapId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([markmapId])
}

model Interaction {
  id            String   @id @default(uuid())
  type          String   // e.g., "expand", "collapse", "search"
  metadata      Json?
  interactedAt  DateTime @default(now())

  userId        String?
  user          User?    @relation(fields: [userId], references: [id])
  markmapId     String
  markmap       Markmap  @relation(fields: [markmapId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([markmapId])
}

model Tag {
  id        String         @id @default(uuid())
  name      String         @unique // Tag name with # prefix (e.g., "#javascript")
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  markmaps  TagOnMarkmap[]

  @@index([name])
}

model TagOnMarkmap {
  id         String   @id @default(uuid())
  tagId      String
  markmapId  String
  createdAt  DateTime @default(now())

  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  markmap    Markmap  @relation(fields: [markmapId], references: [id], onDelete: Cascade)

  @@unique([tagId, markmapId])
  @@index([tagId])
  @@index([markmapId])
  @@index([createdAt])
}

model Series {
  id          String    @id @default(uuid())
  name        String    // Series name
  slug        String    // URL-friendly version of series name
  description String?   // Optional series description
  isPublic    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  authorId    String
  author      User      @relation(fields: [authorId], references: [id])
  markmaps    Markmap[]

  @@unique([authorId, slug])
  @@index([authorId])
  @@index([slug])
  @@index([isPublic])
}

model UserPreferences {
  id                    String   @id @default(uuid())
  darkTheme             Boolean  @default(false)
  language              String   @default("en")
  profilePageVisible    Boolean  @default(true)
  profilePictureVisible Boolean  @default(true)
  emailVisible          Boolean  @default(true)
  emailComplaintsNotifications Boolean @default(true)  // Email notifications for complaints
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Keynode status enum
enum KeynodeStatus {
  unverified
  verified
  alias
}

model Keynode {
  id              String         @id @default(uuid())
  name            String         @unique // Keynode name (e.g., "volcano", "Albert Einstein")
  category        String         // Category: person, fictional_character, geographical_location, date_time, historical_event, biological_species, abstract_concept, others
  status          KeynodeStatus  @default(unverified) // Keynode verification status
  childNodeCount  Int            @default(0) // Number of child nodes referencing this keynode
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  parentId        String?
  parent          Keynode?       @relation("KeynodeHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children        Keynode[]      @relation("KeynodeHierarchy")
  
  createdById     String?        // User who created this keynode
  createdBy       User?          @relation("KeynodeCreator", fields: [createdById], references: [id], onDelete: SetNull)
  
  aliasOfId       String?        // If this is an alias, points to the canonical keynode
  aliasOf         Keynode?       @relation("KeynodeAlias", fields: [aliasOfId], references: [id], onDelete: SetNull)
  aliases         Keynode[]      @relation("KeynodeAlias")
  
  markmaps        KeynodeOnMarkmap[]

  @@index([name])
  @@index([category])
  @@index([status])
  @@index([parentId])
  @@index([childNodeCount])
  @@index([createdById])
  @@index([aliasOfId])
}

model KeynodeOnMarkmap {
  id         String   @id @default(uuid())
  keynodeId  String
  markmapId  String
  createdAt  DateTime @default(now())

  keynode    Keynode  @relation(fields: [keynodeId], references: [id], onDelete: Cascade)
  markmap    Markmap  @relation(fields: [markmapId], references: [id], onDelete: Cascade)

  @@unique([keynodeId, markmapId])
  @@index([keynodeId])
  @@index([markmapId])
  @@index([createdAt])
}

// Complaint reason enum
enum ComplaintReason {
  harassment
  false_information
  author_right_infringement
  inciting_violence_hate
  discriminatory_abusive
}

// Complaint status enum
enum ComplaintStatus {
  pending
  sustained      // Complaint was valid, markmap retired
  dismissed      // Complaint was invalid
  appealed       // User appealed after dismissal (escalated to admin)
}

model Complaint {
  id            String           @id @default(uuid())
  reason        ComplaintReason
  explanation   String           // Must be at least 5 words
  status        ComplaintStatus  @default(pending)
  resolution    String?          // Explanation of resolution decision
  createdAt     DateTime         @default(now())
  resolvedAt    DateTime?
  
  markmapId     String
  markmap       Markmap          @relation(fields: [markmapId], references: [id], onDelete: Cascade)
  
  reporterId    String?          // Can be null for anonymous complaints
  reporter      User?            @relation("ComplaintReporter", fields: [reporterId], references: [id], onDelete: SetNull)
  
  resolvedById  String?          // Content manager or admin who resolved
  resolvedBy    User?            @relation("ComplaintResolver", fields: [resolvedById], references: [id], onDelete: SetNull)
  
  @@index([markmapId])
  @@index([reporterId])
  @@index([status])
  @@index([createdAt])
}

// Notification type enum
enum NotificationType {
  complaint_sustained    // Your markmap was retired due to a sustained complaint
  complaint_dismissed    // A complaint you filed was dismissed
  complaint_appealed     // Notifying admin/reporter of appeal
  markmap_reinstated     // Your markmap was reinstated after review
  markmap_needs_edit     // Your edited markmap needs further changes
  keynode_approved       // Your keynode was approved
  keynode_rejected       // Your keynode was rejected
}

model Notification {
  id            String           @id @default(uuid())
  type          NotificationType
  title         String
  message       String
  isRead        Boolean          @default(false)
  createdAt     DateTime         @default(now())
  
  userId        String
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Optional references to related entities
  markmapId     String?
  complaintId   String?
  keynodeId     String?
  
  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
}
